---
title: ""
output: 
  html_document:
    toc: true
    toc_float: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# icon_info <- shiny::icon("info")
```
  
\
Cette application web **estime les fonctions de distribution de la sensibilité des espèces grâce aux données de concentration.** L’application est faite à partir de l’application R [ssdtools](https://github.com/bcgov/ssdtools), et partage les mêmes fonctions. 

*Astuce: Clic sur les icônes «info« pour obtenir plus d’informations.*

\

### Étape 1: Fournir les données

* Les données ne doivent être fournies que pour **une substance chimique** à la fois.
* Une seule valeur doit être entrée par espèce. 
* L’ensemble des données doit former **au moins 1 colonne** comportant au **minimum 8 concentrations distinctes et positives**.
* Des colonnes pour **les espèces et les groupes** taxonomiques peuvent également être ajoutées. Des étiquettes et des couleurs sont alors disponibles pour permettre leur identification dans le graphique. 
```{r data-demo, echo=FALSE, message = FALSE}
library(knitr)
library(dplyr)
library(stringr)
library(kableExtra)
df <- ssdtools::boron_data[1:8,] %>% dplyr::select(Concentration = Conc, Species, Group)
df <- df %>% dplyr::rename(Espèce = Species,
             Groupe = Group)
df$Groupe <- df$Groupe %>%
  stringr::str_replace("Fish", "Poisson") %>%
  stringr::str_replace("Invertebrate", "Invertébré") %>%
  stringr::str_replace("Amphibian", "Amphibien") %>%
  stringr::str_replace("Plant", "Plante")
kable(df) %>% kable_styling("bordered", full_width = FALSE, font_size = 11)
```
* Des colonnes additionnelles sont possibles mais ne sont pas reliées à aucune fonction. 

Trois options sont possibles pour déposer les données dans l’application:

1. **Utiliser les données démo du Bore.**
    - Permet de connaitre rapidement les fonctions de l’application avec un ensemble «fonctionnel» de données.
2. **Télécharger un fichier .csv.**
    - Le format Excel n’est pas accepté. Si vous avez un fichier Excel, il faut l’exporter dans une feuille de calcul .csv.
3. **Remplir le tableau interactif.**
    - Cliquer sur une cellule pour commencer à rentrer les données. Faire un clic-droit pour ajouter ou supprimer des colonnes ou des rangées. Le nom des colonnes ne peut pas être modifiés. 

Enfin, visualiser les données fournies dans le tableau à droite de l'onglet.
\

<center>
![Données fournies dans le tableau 1. Données](https://media.giphy.com/media/fjyG7Wbgp1RKV8sS9s/giphy.gif)

</center>
  
\

### Étape 2: Estimations des distributions 

1. Spécifier **quelle est la colonne qui contient les concentrations**.
2. **Sélectionner (ou désélectionner) les distributions.** La fonction peut prendre quelques secondes pour se mettre à jour. 
3. Mise en forme le graphique en cliquant sur l’option. **Télécharger le graphique et le tableau des degrés d’ajustement** dans un fichier .png et .csv, respectivement. 
\

 <center>

![Ajustement des distributions apparaissant au tableau 2. Estimation](https://media.giphy.com/media/yIjxGcFKt0zK2vj38j/giphy.gif)

</center>

Information additionnelle sur **le tableau des degrés d’ajustement**:
Les colonnes du tableau des degrés d’ajustement sont la distribution (dist), la statistique d’Anderson-Darling (ad), la statistique de Kolmogorov-Smirnov (ks), la statistique de Cramer-von-Mises (cmv), le critère d’information Akaike (aic), le critère d’information Akaike corrigé pour la taille de l’échantillon (aicc), le critère d’information Bayésien (bic), la différence AICc (delta) et le coefficient AICc basé sur le poids Akaike (weight). L’estimation de la fonction de distribution finale (modèle agrégé) est basée sur l’inférence multimodèle (à partir de l’ aicc). La concentration du -centile limite (ex. HC5) est la concentration estimée d’une substance affectant ce -centile (ex. 5%) de l’ensemble des espèces.   
\

### Étape 3: Estimation de la concentration limite 
1. Sélectionner le **seuil (%) des espèces affectées** pour calculer **l’estimation de la concentration limite.** Cela s’ajuste sur le graphique (ligne pointillée), dans le texte en dessous et dans le calcul de l’intervalle de confiance.
2. Sélectionner le nombre de **simulations bootstrap pour le calcul de l’intervalle de condiance.** Il est recommandé d’utiliser 10 000 simulations. Le calcul prendra environ 3 minutes.  Sélectionner un nombre moindre de simulations bootstrap pour obtenir un temps de calcul plus court. 
\
```{r cl-time, echo=FALSE, message = FALSE}
library(tibble)
tibble(`Nombre de simulation Bootstrap` = c(10000, 5000, 1000, 500),
           `Temps de calcul estimé` = c("3 minutes", "1.5 minutes", "15 secondes", "10 secondes")) %>% kable() %>%
  kable_styling("bordered", full_width = FALSE, font_size = 11)
```


3. Les intervalles de confiance ne sont pas calculés automatiquement car cela prend un certain temps. Il faut cliquer sur le `Get CL` bouton.
4. **Le graphique peut être modifié** de diverses façons. **Le graphique et le tableau sont téléchargés** dans un fichier .png et .csv, respectivement.
    - Si l’étiquette des espèces n’est pas entièrement visible sur le graphique, ajuster l’axe des X et la position des étiquettes en utilisant la fonction étiquette 'X-axis max' et 'Adjust label'.
    - L’éventail de couleurs provient de [ColorBrewer](http://colorbrewer2.org/#type=sequential&scheme=BuGn&n=3).
    - Si vous utilisez la même variable pour la couleur et la forme, fournir le même titre de légende permettra de combiner les deux en une seule légende. 
    
\
 <center>
![Éventail de couleurs ColorBrewer](user-guide/cb-qual.png){width=450px}

</center>
\
 <center>
![Obtenir les intervalles de confiance et estimation de la concentration de risque (Ex. HC5)](https://media.giphy.com/media/xKb9nQsPFlqTCGzUgF/giphy.gif)

</center>

\

### Étape 4: obtenir le code R

Copier le code R pour reproduire la programmation. Le code est ajouté après chaque exécution dans l’application. (par exemple : le code qui génère l’estimation des intervalles de confiance apparaitra après que `Obtenir CL` aura été cliqué.  
 <center>

![Obtenir le code R pour reproduire la programmation dans ](https://media.giphy.com/media/XIgsL03rRnEfn8nNas/giphy.gif)

</center>



